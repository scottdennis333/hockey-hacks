name: Starting Goalies Scheduler

on:
  schedule:
    - cron: "55 0-2,15-23 * * *"
  repository_dispatch:
    types: [run-goalies]
  workflow_dispatch:

env:
  SECRETS: ${{ secrets.SECRETS }}

jobs:
  run-starting-goalies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for recent runs (prevent duplicates)
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const currentHour = now.getUTCHours();
            const currentMinute = now.getUTCMinutes();

            console.log(`Current UTC time: ${currentHour}:${currentMinute.toString().padStart(2, '0')}`);

            // Get recent workflow runs from the last hour
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'starting-goalies.yml',
              per_page: 10,
              status: 'completed'
            });

            // Check if any runs completed in the last hour
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            const recentRuns = runs.workflow_runs.filter(run =>
              new Date(run.updated_at) > oneHourAgo &&
              run.conclusion === 'success'
            );

            console.log(`Found ${recentRuns.length} successful runs in the last hour`);

            if (recentRuns.length > 0) {
              const lastRun = recentRuns[0];
              console.log(`Last successful run: ${lastRun.updated_at}`);
              console.log('Program already ran recently, skipping to prevent duplicate...');
              process.exit(0);
            }

            console.log('No recent successful runs found, proceeding with goalie check...');

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Create .env file from JSON secret
        run: |
          echo '${{ secrets.SECRETS }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' > .env

      - name: Download dependencies
        run: go mod download

      - name: Run starting goalies program
        run: |
          cd cmd/startingGoalies
          go run main.go

      - name: Upload logs (optional)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: goalies-logs
          path: cmd/startingGoalies/logs.log
          retention-days: 7
